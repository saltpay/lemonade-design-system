name: Publish Flutter Package

on:
  push:
    tags:
      - 'lemonade-flutter-*'  # Triggers on tags starting with 'lemonade-flutter-' (e.g., lemonade-flutter-v0.0.1)
jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Fetch tags
        run: git fetch origin '+refs/tags/*:refs/tags/*'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'

      - name: Set version
        run: |
          # Extract version from tag (remove 'lemonade-flutter-' prefix)
          echo "PUBLICATION_VERSION=${GITHUB_REF#refs/tags/lemonade-flutter-}" >> $GITHUB_ENV

      - name: Get previous tag
        id: previous-tag
        run: |
          # Get all tags matching the pattern, sorted by version
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          PREVIOUS_TAG=$(git tag -l 'lemonade-flutter-*' --sort=-version:refname | grep -A1 "^${CURRENT_TAG}$" | tail -n1)

          if [ "$PREVIOUS_TAG" != "$CURRENT_TAG" ] && [ -n "$PREVIOUS_TAG" ]; then
            echo "previous-tag=${PREVIOUS_TAG}" >> $GITHUB_OUTPUT
            echo "has-previous=true" >> $GITHUB_OUTPUT
            echo "Previous tag found: ${PREVIOUS_TAG}"
          else
            echo "has-previous=false" >> $GITHUB_OUTPUT
            echo "No previous tag found"
          fi

      - name: Generate changelog
        id: changelog
        if: steps.previous-tag.outputs.has-previous == 'true'
        run: |
          PREVIOUS_TAG="${{ steps.previous-tag.outputs.previous-tag }}"
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"

          # Generate changelog for commits that touched flutter/ folder only
          CHANGELOG=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --oneline --no-merges -- flutter/ | sed 's/^/• /')

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="• No changes to flutter/ folder in this release"
          fi

          # Save to output (handle multiline)
          echo "changes<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Install dependencies
        run: flutter pub get
        working-directory: ./flutter

      - name: Run tests
        run: flutter test
        working-directory: ./flutter

      - name: Send Slack notification
        if: ${{ !cancelled() && !failure() }}
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: 'C09JFLZKR3P'
          slack-message: |
            :flutter:
            *[FLUTTER RELEASE] Lemonade Flutter Published*

            *Release Info*
            • Version: `${{ env.PUBLICATION_VERSION }}`
            • Triggered by: `${{ github.actor }}`

            *What's Changed*
            ${{ steps.previous-tag.outputs.has-previous == 'true' && steps.changelog.outputs.changes || '• First release - no previous tag to compare' }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}