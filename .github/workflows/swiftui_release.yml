name: Publish SwiftUI to JFrog

on:
  push:
    tags:
      - 'lemonade-swiftui-*'  # Triggers on tags like lemonade-swiftui-1.0.0

env:
  JFROG_USER: ${{ secrets.JFROG_USER }}
  JFROG_PASSWORD: ${{ secrets.JFROG_PASSWORD }}
  # Using main-maven-local with Maven path structure (same as KMP)
  JFROG_BASE_URL: "https://saltpay.jfrog.io/artifactory/main-maven-local/com/teya/lemonade-design-system/lemonade-swiftui"

jobs:
  publish:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Fetch tags
        run: git fetch origin '+refs/tags/*:refs/tags/*'

      - name: Set version from tag
        run: |
          # Extract version from tag (remove 'lemonade-swiftui-' prefix)
          VERSION="${GITHUB_REF#refs/tags/lemonade-swiftui-}"
          echo "LEMONADE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Publishing version: $VERSION"

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Build XCFramework
        working-directory: ./swiftui
        run: |
          chmod +x scripts/build_xcframework.sh
          ./scripts/build_xcframework.sh

      - name: Calculate checksum for SPM
        id: checksum
        working-directory: ./swiftui
        run: |
          CHECKSUM=$(shasum -a 256 build/Lemonade.xcframework.zip | awk '{print $1}')
          echo "CHECKSUM=$CHECKSUM" >> $GITHUB_ENV
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "SHA256 Checksum: $CHECKSUM"

      - name: Get previous tag
        id: previous-tag
        run: |
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          PREVIOUS_TAG=$(git tag -l 'lemonade-swiftui-*' --sort=-version:refname | grep -A1 "^${CURRENT_TAG}$" | tail -n1)

          if [ "$PREVIOUS_TAG" != "$CURRENT_TAG" ] && [ -n "$PREVIOUS_TAG" ]; then
            echo "previous-tag=${PREVIOUS_TAG}" >> $GITHUB_OUTPUT
            echo "has-previous=true" >> $GITHUB_OUTPUT
            echo "Previous tag found: ${PREVIOUS_TAG}"
          else
            echo "has-previous=false" >> $GITHUB_OUTPUT
            echo "No previous tag found"
          fi

      - name: Generate changelog
        id: changelog
        if: steps.previous-tag.outputs.has-previous == 'true'
        run: |
          PREVIOUS_TAG="${{ steps.previous-tag.outputs.previous-tag }}"
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"

          CHANGELOG=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --oneline --no-merges -- swiftui/ | sed 's/^/• /')

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="• No changes to swiftui/ folder in this release"
          fi

          echo "changes<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload XCFramework to JFrog
        working-directory: ./swiftui
        run: |
          echo "Uploading Lemonade.xcframework.zip to JFrog..."
          curl -f -u "$JFROG_USER:$JFROG_PASSWORD" \
            -T "build/Lemonade.xcframework.zip" \
            "${{ env.JFROG_BASE_URL }}/${{ env.LEMONADE_VERSION }}/Lemonade.xcframework.zip"
          echo "XCFramework upload complete!"

      - name: Generate and upload Podspec
        working-directory: ./swiftui
        run: |
          # Generate podspec with correct version
          sed "s/spec.version      = \"1.0.0\"/spec.version      = \"${{ env.LEMONADE_VERSION }}\"/" \
            Lemonade.podspec > build/Lemonade.podspec

          echo "Uploading Lemonade.podspec to JFrog..."
          curl -f -u "$JFROG_USER:$JFROG_PASSWORD" \
            -T "build/Lemonade.podspec" \
            "${{ env.JFROG_BASE_URL }}/${{ env.LEMONADE_VERSION }}/Lemonade.podspec"
          echo "Podspec upload complete!"

      - name: Generate and upload SPM Package.swift
        working-directory: ./swiftui
        run: |
          # Generate Package.swift for SPM binary distribution
          sed -e "s|__VERSION__|${{ env.LEMONADE_VERSION }}|g" \
              -e "s|__CHECKSUM__|${{ env.CHECKSUM }}|g" \
            scripts/Package.swift.template > build/Package.swift

          echo "Generated Package.swift:"
          cat build/Package.swift

          echo "Uploading Package.swift to JFrog..."
          curl -f -u "$JFROG_USER:$JFROG_PASSWORD" \
            -T "build/Package.swift" \
            "${{ env.JFROG_BASE_URL }}/${{ env.LEMONADE_VERSION }}/Package.swift"
          echo "Package.swift upload complete!"

      - name: Upload latest version marker
        run: |
          # Create a file with the latest version for easy reference
          echo "${{ env.LEMONADE_VERSION }}" > latest_version.txt
          # Delete existing file first (JFrog doesn't allow overwriting)
          curl -u "$JFROG_USER:$JFROG_PASSWORD" -X DELETE \
            "${{ env.JFROG_BASE_URL }}/latest_version.txt" || true
          # Upload new version marker
          curl -f -u "$JFROG_USER:$JFROG_PASSWORD" \
            -T "latest_version.txt" \
            "${{ env.JFROG_BASE_URL }}/latest_version.txt"

      - name: Send Slack notification
        if: ${{ !cancelled() && !failure() }}
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: 'C09JFLZKR3P'
          slack-message: |
            :apple:
            *[SwiftUI RELEASE] Lemonade SwiftUI Published*

            *Release Info*
            • Version: `${{ env.LEMONADE_VERSION }}`
            • Triggered by: `${{ github.actor }}`
            • Checksum: `${{ env.CHECKSUM }}`

            *What's Changed*
            ${{ steps.previous-tag.outputs.has-previous == 'true' && steps.changelog.outputs.changes || '• First release - no previous tag to compare' }}

            *Installation (CocoaPods)*
            ```ruby
            pod 'Lemonade', :http => 'https://saltpay.jfrog.io/artifactory/main-maven-local/com/teya/lemonade-design-system/lemonade-swiftui/${{ env.LEMONADE_VERSION }}/Lemonade.xcframework.zip'
            ```

            *Installation (SPM)*
            ```
            URL: https://saltpay.jfrog.io/artifactory/main-maven-local/com/teya/lemonade-design-system/lemonade-swiftui/${{ env.LEMONADE_VERSION }}/Package.swift
            ```

            <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|:link: View Build Details>
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
