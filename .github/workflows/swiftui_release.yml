name: Publish SwiftUI Release

on:
  push:
    tags:
      - 'lemonade-swiftui-*'

permissions:
  contents: write

jobs:
  publish:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Fetch tags
        run: git fetch origin '+refs/tags/*:refs/tags/*'

      - name: Set version from tag
        run: |
          VERSION="${GITHUB_REF#refs/tags/lemonade-swiftui-}"
          echo "LEMONADE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Publishing version: $VERSION"

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Build XCFramework
        working-directory: ./swiftui
        run: |
          chmod +x scripts/build_xcframework.sh
          ./scripts/build_xcframework.sh

      - name: Calculate checksum for SPM
        id: checksum
        working-directory: ./swiftui
        run: |
          CHECKSUM=$(shasum -a 256 build/Lemonade.xcframework.zip | awk '{print $1}')
          echo "CHECKSUM=$CHECKSUM" >> $GITHUB_ENV
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "SHA256 Checksum: $CHECKSUM"

      - name: Get previous tag
        id: previous-tag
        run: |
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          PREVIOUS_TAG=$(git tag -l 'lemonade-swiftui-*' --sort=-version:refname | grep -A1 "^${CURRENT_TAG}$" | tail -n1)

          if [ "$PREVIOUS_TAG" != "$CURRENT_TAG" ] && [ -n "$PREVIOUS_TAG" ]; then
            echo "previous-tag=${PREVIOUS_TAG}" >> $GITHUB_OUTPUT
            echo "has-previous=true" >> $GITHUB_OUTPUT
            echo "Previous tag found: ${PREVIOUS_TAG}"
          else
            echo "has-previous=false" >> $GITHUB_OUTPUT
            echo "No previous tag found"
          fi

      - name: Generate changelog
        id: changelog
        if: steps.previous-tag.outputs.has-previous == 'true'
        run: |
          PREVIOUS_TAG="${{ steps.previous-tag.outputs.previous-tag }}"
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"

          CHANGELOG=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --oneline --no-merges -- swiftui/ | sed 's/^/• /')

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="• No changes to swiftui/ folder in this release"
          fi

          echo "changes<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: lemonade-swiftui-${{ env.LEMONADE_VERSION }}
          name: Lemonade SwiftUI ${{ env.LEMONADE_VERSION }}
          body: |
            ## Lemonade SwiftUI ${{ env.LEMONADE_VERSION }}

            ### What's Changed
            ${{ steps.previous-tag.outputs.has-previous == 'true' && steps.changelog.outputs.changes || '• First release - no previous tag to compare' }}

            ### Installation (SPM - Binary Target)

            Add to your `Package.swift`:
            ```swift
            .binaryTarget(
                name: "Lemonade",
                url: "https://github.com/${{ github.repository }}/releases/download/lemonade-swiftui-${{ env.LEMONADE_VERSION }}/Lemonade.xcframework.zip",
                checksum: "${{ env.CHECKSUM }}"
            )
            ```

            ### Checksum
            **SHA256:** `${{ env.CHECKSUM }}`
          files: |
            swiftui/build/Lemonade.xcframework.zip

      - name: Send Slack notification
        if: ${{ !cancelled() && !failure() }}
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: 'C09JFLZKR3P'
          slack-message: |
            :apple:
            *[SwiftUI RELEASE] Lemonade SwiftUI Published*

            *Release Info*
            • Version: `${{ env.LEMONADE_VERSION }}`
            • Triggered by: `${{ github.actor }}`
            • Checksum: `${{ env.CHECKSUM }}`

            *What's Changed*
            ${{ steps.previous-tag.outputs.has-previous == 'true' && steps.changelog.outputs.changes || '• First release - no previous tag to compare' }}

            *Installation (SPM)*
            ```swift
            .binaryTarget(
                name: "Lemonade",
                url: "https://github.com/${{ github.repository }}/releases/download/lemonade-swiftui-${{ env.LEMONADE_VERSION }}/Lemonade.xcframework.zip",
                checksum: "${{ env.CHECKSUM }}"
            )
            ```

            <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|:link: View Build Details>
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
